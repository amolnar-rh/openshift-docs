// Module included in the following assemblies:
// * edge_computing/image-based-upgrade/cnf-preparing-for-image-based-upgrade.adoc

:_mod-docs-content-type: PROCEDURE
[id="cnf-image-based-upgrade-creating-backup-oadp-resources_{context}"]
= Creating OADP ConfigMap objects for the image-based upgrade with {lcao}

Create your OADP resources that are used to back up and restore your resources during the upgrade.

.Prerequisites

* Generate a seed image from a compatible seed cluster.
* Create backup and restore resources.
* Create a separate partition on the target cluster for the container images that is shared between stateroots. For more information about, see _Additional resources_.
* Deploy a version of {lcao} that is compatible with the version used with the seed image.
* Install the OADP Operator, the `DataProtectionApplication` CR and its secret on the target cluster.
* Create an S3-compatible storage solution and a ready-to-use bucket with proper credentials configured. For more information, see _Additional resources_.

.Procedure

. Create the OADP `Backup` and `Restore` CRs for platform artifacts in the same namespace where the OADP Operator is installed, which is `openshift-adp`.

.. If the target cluster is managed by {rh-rhacm}, add the following YAML file for backing up and restoring {rh-rhacm} artifacts:
+
--
.PlatformBackupRestore.yaml for LSO
include::snippets/ibu-PlatformBackupRestore.adoc[]
--

.. If you created persistent volumes on your cluster through {lvms}, add the following YAML file for {lvms} artifacts:
+
.PlatformBackupRestoreLvms.yaml for {lvms}
include::snippets/ibu-PlatformBackupRestoreLvms.adoc[]

. (Optional) If you need to restore applications over the upgrade, create the OADP `Backup` and `Restore` CRs for your application in the `openshift-adp` namespace.

.. Create the OADP CRs for cluster-scoped application artifacts in the `openshift-adp` namespace.
+
.Example OADP CRs for cluster-scoped application artifacts for LSO and {LVMS}
include::snippets/ibu-ApplicationClusterScopedBackupRestore.adoc[]

.. Create the OADP CRs for your namespace-scoped application artifacts.
+
--
.Example OADP CRs namespace-scoped application artifacts when LSO is used
include::snippets/ibu-ApplicationBackupRestoreLso.adoc[]

.Example OADP CRs namespace-scoped application artifacts when {lvms} is used
include::snippets/ibu-ApplicationBackupRestoreLvms.adoc[]

[IMPORTANT]
====
The same version of the applications must function on both the current and the target release of {product-title}.
====
--

. Generate a `ConfigMap` object for your OADP CRs.

.. Create the `ConfigMap` object:
+
[source,terminal]
----
$ oc create configmap oadp-cm-example --from-file=example-oadp-resources.yaml=<path_to_oadp_crs> -n openshift-adp
----

. Patch the `ImageBasedUpgrade` CR:
+
[source,terminal]
----
$ oc patch imagebasedupgrades.lca.openshift.io upgrade \
-p='{"spec": {"oadpContent": [{"name": "oadp-cm-example", "namespace": "openshift-adp"}]}}' \
--type=merge -n openshift-lifecycle-agent
----

[id="cnf-image-based-upgrade-creating-backup-extra-manifests_{context}"]
== (Optional) Creating ConfigMap objects of extra manifests for the image-based upgrade with {lcao}

Create your additional manifests that you want to apply to the target cluster.

.Procedure

. Create a YAML file that contains your extra manifests.
+
[source,yaml]
----
apiVersion: sriovnetwork.openshift.io/v1
kind: SriovNetworkNodePolicy
metadata:
  name: "pci-sriov-net-e5l"
  namespace: openshift-sriov-network-operator
spec:
  deviceType: vfio-pci
  isRdma: false
  nicSelector:
    pfNames: [ens1f0]
  nodeSelector:
    node-role.kubernetes.io/master: ""
  mtu: 1500
  numVfs: 8
  priority: 99
  resourceName: pci_sriov_net_e5l
---
apiVersion: sriovnetwork.openshift.io/v1
kind: SriovNetwork
metadata:
  name: "networking-e5l"
  namespace: openshift-sriov-network-operator
spec:
  ipam: |-
    {
    }
  linkState: auto
  networkNamespace: sriov-namespace
  resourceName: pci_sriov_net_e5l
  spoofChk: "on"
  trust: "off"
----

. Create the `ConfigMap` object:
+
[source,terminal]
----
$ oc create configmap example-extra-manifests-cm --from-file=example-extra-manifests.yaml=<path_to_extramanifest> -n openshift-lifecycle-agent
----

. Patch the `ImageBasedUpgrade` CR:
+
[source,terminal]
----
$ oc patch imagebasedupgrades.lca.openshift.io upgrade \
-p='{"spec": {"extraManifests": [{"name": "example-extra-manifests-cm", "namespace": "openshift-lifecycle-agent"}]}}' \
--type=merge -n openshift-lifecycle-agent
----

[id="cnf-image-based-upgrade-creating-backup-custom-catalog-sources_{context}"]
== (Optional) Creating ConfigMap objects of custom catalog sources for the image-based upgrade with {lcao}

You can keep your custom catalog sources after the upgrade by generating a `ConfigMap` object for your catalog sources and adding them to the `spec.extraManifest` field in the `ImageBasedUpgrade` CR.
For more information about catalog sources, see xref:https://access.redhat.com/documentation/en-us/openshift_container_platform/4.15/html-single/operators/index#olm-catalogsource_olm-understanding-olm[Catalog source].

.Procedure

. Create a YAML file that contains the `CatalogSource` CR.
+
--
[source,yaml]
----
apiVersion: operators.coreos.com/v1
kind: CatalogSource
metadata:
  name: example-catalogsources
  namespace: openshift-marketplace
spec:
  sourceType: grpc
  displayName: disconnected-redhat-operators
  image: quay.io/example-org/example-catalog:v1
----
--

. Create the `ConfigMap` object:
+
[source,terminal]
----
$ oc create configmap example-catalogsources-cm --from-file=example-catalogsources.yaml=<path_to_catalogsource_cr> -n openshift-lifecycle-agent
----

. Patch the `ImageBasedUpgrade` CR:
+
[source,terminal]
----
$ oc patch imagebasedupgrades.lca.openshift.io upgrade \
-p='{"spec": {"extraManifests": [{"name": "example-catalogsources-cm", "namespace": "openshift-lifecycle-agent"}]}}' \
--type=merge -n openshift-lifecycle-agent
----

To use the `ConfigMap` objects in the upgrade, see the _Performing an image-based upgrade with {lcao}_ section.