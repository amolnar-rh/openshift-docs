// Module included in the following assemblies:
// * scalability_and_performance/ztp-image-based-upgrade.adoc

:_mod-docs-content-type: PROCEDURE
[id="ztp-image-based-upgrade-with-rhacm_{context}"]
= Upgrading {sno} clusters using {lcao} and {rh-rhacm}

You can upgrade your managed {sno} cluster with the image-based upgrade through {rh-rhacm}.

[id="ztp-image-based-upgrade-prep_{context}"]
== Preparing the {sno} cluster for the image-based upgrade with {rh-rhacm}

When you deploy the {lcao} on a cluster, an `ImageBasedUpgrade` CR is automatically created.
You edit this CR to specify the image repository of the seed image and to move through the different stages.

.Prerequisites

* Generate a seed image from a compatible seed cluster.
* Create backup and restore resources.
* Create a separate partition on the target cluster for the container images that is shared between stateroots. For more information about, see _Additional resources_.
* Deploy a version of {lcao} that is compatible with the version used with the seed image.

.Procedure

. Change the value of the `stage` field to `Prep` in the `ImageBasedUpgrade` CR:
+
[source,terminal]
----
$ oc patch imagebasedupgrades.lca.openshift.io example-upgrade -p='{"spec": {"stage": "Prep"}}' --type=merge -n openshift-lifecycle-agent
----

+
The {lcao} checks for the health of the cluster, creates a new `ostree` stateroot, and pulls the seed image to the target cluster.
Then, the Operator precaches all the required images on the target cluster.

.Verification

. Check the status of the `ImageBasedUpgrade` CR.
+
[source,terminal]
----
$ oc get ibu -A -oyaml
----

+
.Example output
[source,yaml]
----
status:
  conditions:
  - lastTransitionTime: "2024-01-01T09:00:00Z"
    message: In progress
    observedGeneration: 2
    reason: InProgress
    status: "False"
    type: Idle
  - lastTransitionTime: "2024-01-01T09:00:00Z"
    message: 'Prep completed: total: 121 (pulled: 1, skipped: 120, failed: 0)'
    observedGeneration: 2
    reason: Completed
    status: "True"
    type: PrepCompleted
  - lastTransitionTime: "2024-01-01T09:00:00Z"
    message: Prep completed
    observedGeneration: 2
    reason: Completed
    status: "False"
    type: PrepInProgress
  observedGeneration: 2
----