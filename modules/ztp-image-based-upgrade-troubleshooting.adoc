// Module included in the following assemblies:
// * scalability_and_performance/ztp-image-based-upgrade.adoc

:_mod-docs-content-type: PROCEDURE
[id="ztp-image-based-upgrade-troubleshooting_{context}"]
= Troubleshooting

You can encounter issues during the image-based upgrade.

[id="ztp-image-based-upgrade-troubleshooting-must-gather_{context}"]
== Collect logs

You can use the `oc adm must-gather` CLI to collect information for debugging and troubleshooting.

.Procedure

. Collect data about the Operators by running the following command:
+
[source,terminal]
----
$  oc adm must-gather \
--dest-dir=must-gather/tmp \
--image=$(oc -n openshift-lifecycle-agent get deployment.apps/lifecycle-agent-controller-manager -o jsonpath='{.spec.template.spec.containers[?(@.name == "manager")].image}') \
--image=quay.io/konveyor/oadp-must-gather:latest \ <1>
--image=quay.io/openshift/origin-must-gather:latest <1>
----
<1> (Optional) You can add these options if you need to gather more information from the OADP and the SR-IOV Operators.

[id="ztp-image-based-upgrade-troubleshooting-manual-cleanup_{context}"]
== `AbortFailed` or `FinalizeFailed` error

During the finalize stage or when you stop the process at the `Prep` stage, normally, {lcao} cleans up the following resources:

* Stateroot that is no longer required
* Precaching resources
* OADP CRs
* `ImageBasedUpgrade` CR

If the {lcao} fails to perform the above steps, it transitions to the `AbortFailed` or `FinalizeFailed` states.
The condition message and log shows which steps failed.

.Example error message
[source,yaml]
----
message: failed to delete all the backup CRs. Perform cleanup manually then add 'lca.openshift.io/manual-cleanup-done' annotation to ibu CR to transition back to Idle
      observedGeneration: 5
      reason: AbortFailed
      status: "False"
      type: Idle
----

.Procedure

. Inspect the logs to determine why the failure occured.

. To prompt {lcao} to retry the cleanup, add the `lca.openshift.io/manual-cleanup-done` annotation to the `ImageBasedUpgrade` CR.

After observing this annotation, {lcao} retries the cleanup and if it is successful, the `ImageBasedUpgrade` stage transitions to `Idle`.

If the cleanup fails again, you can manually clean up the resources.

[id="ztp-image-based-upgrade-troubleshooting-stateroot_{context}"]
=== Clean up stateroot manually

Stopping at the `Prep` stage, {lcao} cleans up the new stateroot, and finalizing after a successful upgrade or a rollback, normally, {lcao} cleans up the old stateroot.
If this step fails, it is recommended that you inspect the logs to determine why the failure occured. 

.Procedure

. Check if there are any existing deployments in the stateroot by running the following command:
+
[source,terminal]
----
$ ostree adming status
----

. If there are any, clean up the existing deployment:
+
[source,terminal]
----
$ ostree admin undeploy <index_of_deployment> 
----

. After cleaning up all the deployments of the stateroot, wipe the stateroot directory:
+
[WARNING]
====
Ensure that the booted deployment is not in this stateroot.
====

+
[source,terminal]
----
$ stateroot="<stateroot_to_delete>"
$ unshare -m /bin/sh -c "mount -o remount,rw /sysroot && rm -rf /sysroot/ostree/deploy/${stateroot}"
----

[id="ztp-image-based-upgrade-troubleshooting-oadp-resources_{context}"]
=== Clean up OADP resources manually

This step can fail due to connection issues between {lcao} and the S3 backend. By restoring the connection and adding the `lca.openshift.io/manual-cleanup-done` annotation, the {lcao} can successfully cleanup backup resources.

.Procedure

. Check the backend connectivity by running the following command:
+
[source,terminal]
----
$ oc get backupstoragelocations.velero.io -n openshift-adp
----

+
.Example output
[source,terminal]
----
NAME                          PHASE       LAST VALIDATED   AGE   DEFAULT
dataprotectionapplication-1   Available   33s              8d    true
----

. Remove all backup resources and then add the `lca.openshift.io/manual-cleanup-done` annotation to the `ImageBasedUpgrade` CR.