// Module included in the following assemblies:
// * scalability_and_performance/ztp-image-based-upgrade.adoc

:_mod-docs-content-type: PROCEDURE
[id="ztp-image-based-upgrade-troubleshooting_{context}"]
= Troubleshooting

You can encounter issues during the image-based upgrade.

[id="ztp-image-based-upgrade-troubleshooting-manual-cleanup_{context}"]
== Manual cleanup

During the finalize stage or when you stop the process at the `Prep` stage, normally, {lcao} cleans up the following resources:

* Old stateroot
* Precaching resources
* OADP CRs
* IBU files from the file system
// are these CRs or something else?

If the {lcao} fails to perform the above steps, it transitions to the `AbortFailed` or `FinalizeFailed` states.
The condition message and log shows which steps failed.

.Procedure

. Manually clean up the resources.

. Add the `lca.openshift.io/manual-cleanup-done` annotation to the `ImageBasedUpgrade` CR.

After observing this annotation, {lcao} retries the cleanup and if it is successful, the `ImageBasedUpgrade` stage transitions to `Idle`.

[id="ztp-image-based-upgrade-troubleshooting-stateroot-cleanup_{context}"]
== Stateroot cleanup

Stopping at the `Prep` stage, {lcao} cleans up the new stateroot, and finalizing after a successful upgrade or a rollback, normally, {lcao} cleans up the old stateroot.
If this step fails, it is recommended that you inspect the logs to determine why the failure occured. 

.Procedure

. Inspect the logs to determine why the failure occured.

. To prompt {lcao} to retry the cleanup, add the `lca.openshift.io/manual-cleanup-done` annotation to the `ImageBasedUpgrade` CR.

If the cleanup fails again, you can manually clean up the statreoot.

. Check if there are any existing deployments in the stateroot by running the following command:
+
[source,terminal]
----
$ ostree adming status
----

. If there are any existing deployments, you must clean them up:
+
[source,terminal]
----
$ ostree admin undeploy <index_of_deployment> 
----

. After cleaning up all the deployments of the stateroot, you can wipe the stateroot folder:
+
[WARNING]
====
Ensure that the booted deployment is not in this stateroot.
====

+
[source,terminal]
----
$ stateroot="<stateroot_to_delete>"
$ unshare -m /bin/sh -c "mount -o remount,rw /sysroot && rm -rf /sysroot/ostree/deploy/${stateroot}"
----

[id="ztp-image-based-upgrade-troubleshooting-oadp-cleanup_{context}"]
== OADP resources cleanup

This step can fail due to connection issues between {lcao} and the S3 backend. By restoring the connection and adding the `lca.openshift.io/manual-cleanup-done` annotation, {lcao} can successfully cleanup backup resources.

.Procedure

. Check the backend connectivity by running the following command:
+
[source,terminal]
----
$ oc get backupstoragelocations.velero.io -n openshift-adp
----

+
.Example output
[source,terminal]
----
NAME                          PHASE       LAST VALIDATED   AGE   DEFAULT
dataprotectionapplication-1   Available   33s              8d    true
----

. Add the `lca.openshift.io/manual-cleanup-done` annotation to the `ImageBasedUpgrade` CR.

. (Optional) You can manually remove all backup resources and then add the `lca.openshift.io/manual-cleanup-done` annotation to the `ImageBasedUpgrade` CR.